<div class="container-fluid py-3 h-100" *ngIf="!userComeFirstTime">
  <div class="row g-3 h-100" id="rowBox">
    <!-- Left: Chat -->
    <div id="leftBox" class="col-12 col-lg-6 d-flex flex-column">
      <h1 class="h4 fw-light mb-2 headingClass">{{ staticText.covertional }}</h1>

      <div class="position-relative flex-grow-1 chat-outer-wrap">
        <div class="chat-container border bg-white rounded p-3 h-100 overflow-auto d-flex flex-column" #chatContainerBox>
          <ng-container *ngFor="let message of chatHistory; let i = index">

            <!-- User message -->
            <div *ngIf="message.sender === 'user'" class="mb-2">
              <div *ngIf="message.isFile == true" class="file-info file-info-inside shadow-sm border rounded p-2 bg-light-subtle d-flex align-items-center gap-2">
                <img [src]="fileIcon" alt="file icon" class="flex-shrink-0" width="28" height="28"/>
                <div class="small">
                  <div class="text-truncate fw-semibold" style="max-width:240px">{{ uploadFileName }}</div>
                  <div class="text-secondary">{{ fileExtension }}</div>
                </div>
              </div>
              <div class="d-flex justify-content-end" *ngIf="message.isFile == false">
                <span class="user-text shadow-sm">{{ message.text }}</span>
              </div>
            </div>

            <!-- Bot message -->
            <div *ngIf="message.sender === 'bot'" class="mb-3">
              <!-- Primary text -->
              <div class="d-flex align-items-start gap-2 user-input" *ngIf="isString(message.text)">
                <span><img src="../../assets/images/moji.svg" width="24" height="24" alt=""/> </span>
                <p class="mb-0">{{ message.text }}</p>
              </div>

              <!-- Q + guidelines block -->
              <div *ngIf="!isString(message.text) && !message.followingText">
                <div class="d-flex align-items-start gap-2 user-input">
                  <span><img src="../../assets/images/moji.svg" width="24" height="24" alt=""/></span>
                  <p class="mb-0">{{ message.text.question }}</p>
                </div>
                <div class="guidance-box mt-2 ms-5">
                  <button class="btn btn-sm btn-warning-subtle border-warning text-warning fw-semibold">{{ staticText.guidanceText }}</button>
                  <p class="fw-semibold small mb-2" *ngIf="message.staticBotMessage">{{ message.text.question }}</p>
                  <ul class="ps-3 mb-0" *ngFor="let text of message.text.guidelines">
                    <li class="small" [innerHTML]="text"></li>
                  </ul>
                </div>
              </div>

              <!-- Following ways -->
              <div class="following-ways ms-5 mt-2" *ngIf="message.followingText">
                <p class="small fw-semibold mb-2">{{ message?.followingText?.question }}</p>
                <ul class="ps-3 mb-0">
                  <li class="d-flex align-items-center gap-2"><img src="../../assets/images/edit.svg" alt=""/><span>{{ message?.followingText?.hints[0]}}</span></li>
                  <li class="d-flex align-items-center gap-2"><img src="../../assets/images/attach.svg" alt=""/><span>{{ message?.followingText?.hints[1]}}</span></li>
                  <li class="d-flex align-items-center gap-2"><img src="../../assets/images/mic.svg" alt=""/><span>{{ message?.followingText?.hints[2]}}</span></li>
                </ul>
              </div>

              <!-- Buttons -->
              <div class="user-order ms-5 mt-2" *ngIf="message?.button?.length > 0">
                <ng-container *ngIf="message.fieldName === 'Timelines' || message.fieldName === 'Portfolio alignment'; else yesNo">
                  <button *ngFor="let button of message.button; let j = index"
                          class="btn btn-outline-secondary btn-sm me-2 mb-2"
                          (click)="timeLiButton(message.button[j])">
                    {{button}}
                  </button>
                </ng-container>
                <ng-template #yesNo>
                  <button *ngFor="let button of message.button; let j = index"
                          class="btn btn-outline-secondary btn-sm me-2 mb-2"
                          [ngClass]="{'active-class': selectedIndexOfButton == j}"
                          (click)="yesNoButton(message.button[j])">
                    {{button}}
                  </button>
                </ng-template>
              </div>

              <!-- Mapping Buttons -->
              <div class="user-order ms-5 mt-2" *ngIf="message?.mappingButton?.length > 0">
                <div *ngIf="message.fieldName == 'Business sponsor'">
                  <div class="d-flex flex-wrap gap-2">
                    <button *ngFor="let button of message.mappingButton; let j = index"
                            class="btn btn-outline-secondary btn-sm"
                            [ngClass]="{'active-class': selectedIndexOfButton == j}"
                            (click)="businessMappingButtonClicked(message.mappingButton[j])">
                      {{button}}
                    </button>
                  </div>
                  <div class="d-flex gap-2 mt-2" *ngIf="bussinessMappingButtonClicke">
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="bussinessUserInputForMappingButtons" placeholder="Enter user first and last name" aria-label="Business sponsor"/>
                    <button class="btn btn-primary btn-sm" [disabled]="!bussinessUserInputForMappingButtons" (click)="businessConfirmButton()">{{ staticText.confirmText }}</button>
                  </div>
                </div>

                <div *ngIf="message.fieldName == 'IT sponsor'" class="mt-2">
                  <div class="d-flex flex-wrap gap-2">
                    <button *ngFor="let button of message.mappingButton; let j = index"
                            class="btn btn-outline-secondary btn-sm"
                            [ngClass]="{'active-class': selectedIndexOfButton == j}"
                            (click)="itMappingButtonClicked(message.mappingButton[j])">
                      {{button}}
                    </button>
                  </div>
                  <div class="d-flex gap-2 mt-2" *ngIf="itMappingButtonClicke">
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="itUserInputForMappingButtons" placeholder="Enter user first and last name" aria-label="IT sponsor"/>
                    <button class="btn btn-primary btn-sm" [disabled]="!itUserInputForMappingButtons" (click)="itConfirmButton()">{{ staticText.confirmText }}</button>
                  </div>
                </div>
              </div>

              <!-- Multi select blocks -->
              <div class="multi-select-box ms-5 mt-2" *ngIf="message?.dropdown?.length > 0">
                <div *ngIf="message.fieldName == 'Areas involved'">
                  <div class="d-flex flex-column gap-1">
                    <mat-checkbox [disabled]="confirmBtnOfAreaClk" *ngFor="let region of message.dropdown; let j=index" [(ngModel)]="selectedAreas[j]">
                      <span>{{ region }}</span>
                    </mat-checkbox>
                  </div>
                  <button class="btn btn-primary btn-sm mt-2" [hidden]="confirmBtnOfAreaClk" (click)="onConfirmAreas()">{{ staticText.confirmText }}</button>
                </div>

                <div *ngIf="message.fieldName == 'Destination 2027 alignment'" class="mt-2">
                  <div class="d-flex flex-column gap-1">
                    <mat-checkbox [disabled]="confirmBtnOfDestClk" *ngFor="let region of message.dropdown; let j=index" [(ngModel)]="selectedDestination[j]">
                      {{ region }}
                    </mat-checkbox>
                  </div>
                  <button class="btn btn-primary btn-sm mt-2" [hidden]="confirmBtnOfDestClk" (click)="onConfirmDestination()">{{ staticText.confirmText }}</button>
                </div>

                <div *ngIf="message.fieldName == 'Business case impacts'" class="mt-2">
                  <div class="d-flex flex-column gap-1">
                    <mat-checkbox [disabled]="confirmBtnOfBussClk" *ngFor="let region of message.dropdown; let j=index" [(ngModel)]="selectedBussiness[j]">
                      {{ region }}
                    </mat-checkbox>
                  </div>
                  <button class="btn btn-primary btn-sm mt-2" [hidden]="confirmBtnOfBussClk" (click)="onConfirmBussiness()">{{ staticText.confirmText }}</button>
                </div>
              </div>

            </div>
          </ng-container>

          <div *ngIf="loader" class="d-flex">
            <div class="loader-wrap ms-auto border rounded bg-white p-1"><div class="loader"></div></div>
          </div>
        </div>

        <!-- Composer -->
        <div id="textArDiv" class="send-input-wrap border rounded bg-white d-flex align-items-start gap-2 mt-2 p-2">
          <div *ngIf="selectedFile" class="file-info w-100">
            <div class="file-icon">
              <img [src]="fileIcon" alt="file icon" width="28" height="28"/>
            </div>
            <div class="file-name small">
              <span class="text-truncate" style="max-width:220px">{{ selectedFile.name }}</span>
              <p class="text-secondary mb-0">{{ fileExtension }}</p>
            </div>
            <button (click)="removeFile()" class="btn btn-link p-0 ms-auto" aria-label="Remove file">
              <i class="bi bi-x fs-5"></i>
            </button>
          </div>

          <textarea #autoResizeTextarea
                    class="form-control border-0 shadow-none"
                    rows="1"
                    [(ngModel)]="userInput"
                    (keydown)="onKeyDown($event)"
                    (blur)="onBlur()"
                    (focus)="onFocus()"
                    (input)="onInput()"
                    placeholder="Reply to ADA"
                    id="textAFie"
                    aria-label="Reply to ADA"></textarea>

          <input type="file" (change)="onFileSelected($event)" #fileInput hidden>

          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" (click)="fileInput.click()" [disabled]="uploadFileFirstTime"
                    data-bs-toggle="tooltip" data-bs-title="Upload files (max 20MB each)">
              <i class="bi bi-paperclip"></i>
            </button>
            <button class="btn btn-outline-primary" (click)="startListening()" data-bs-toggle="tooltip" data-bs-title="Use voice mode">
              <i class="bi bi-mic"></i>
            </button>
            <button class="btn btn-primary" id="textAbut"
                    [hidden]="!userInput && !selectedFile"
                    [disabled]="!userInput && !selectedFile"
                    (click)="handleUserInput(userInput)"
                    data-bs-toggle="tooltip" data-bs-title="Reply">
              <i class="bi bi-send"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Fields panel -->
    <div id="rightBox" class="col-12 col-lg-6">
      <div class="fielsReq border bg-white rounded h-100 d-flex flex-column">
        <div class="p-3 border-bottom">
          <div class="row g-2 align-items-center">
            <div class="col">
              <button class="btn btn-link p-0 d-inline-flex align-items-center gap-2 text-decoration-none" (click)="toggleButton()">
                <img src="../../assets/images/business.svg" alt="" width="20" height="20"/>
                <span class="headingClass">{{ staticText.yourIdeaTitle }}</span>
              </button>
            </div>
            <div class="col-auto">
              <div class="d-flex flex-column align-items-end">
                <div class="progress" style="width:140px;height:10px;">
                  <div class="progress-bar bg-success" [style.width.%]="progressPercentage"></div>
                </div>
                <div class="small text-secondary mt-1"><span class="fw-semibold">{{ staticText.Progress }}</span> {{progressPercentage}}% {{ staticText.complete }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="p-3 form-container flex-grow-1 overflow-auto">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">{{ staticText.required }}</h6>
            <button class="btn btn-outline-primary btn-sm" [hidden]="allFieldssLookGoodButton" (click)="AllGoodButton()">{{ staticText.AllGoodButton }}</button>
          </div>

          <div *ngFor="let field of fields; let i = index"
               class="field-container rounded mb-3 p-3"
               [ngClass]="{'bg-light': field.value == '', 'risk-box': i === 8}">
            <div class="d-flex align-items-start gap-3">
              <div class="iconNumbermargin">
                <div *ngIf="field.value == '' || field.value == staticText.ADA_STATIC_TEXT" class="number-series">{{i+1}}</div>
                <img *ngIf="field.completed" src="../../assets/images/step-badge2.svg" alt="step complete"/>
                <img *ngIf="field.value !== '' && !field.completed && field.value !== staticText.ADA_STATIC_TEXT" src="../../assets/images/step-badge.svg" alt="step in progress"/>
              </div>

              <div class="field-text-wrap w-100 position-relative">
                <div class="d-flex align-items-start justify-content-between">
                  <div class="d-flex align-items-center gap-2">
                    <span class="fld-img-wrap"><img [src]="field.image" alt="" width="24" height="24"></span>
                    <label class="fw-semibold small text-secondary mb-0">
                      {{field.label}}
                      <i class="bi bi-info-circle ms-1" data-bs-toggle="tooltip" [title]="field.tooltip"></i>
                    </label>
                  </div>

                  <div class="edit-fields d-flex align-items-center gap-2" *ngIf="field.value !== '' && field.value !== staticText.ADA_STATIC_TEXT && field.label !== 'Additional attachments'">
                    <img *ngIf="field.completed" src="../../assets/images/history.svg" alt="history" role="button" (click)="checkButton(i)"/>
                    <img src="../../assets/images/edit-btn.svg" alt="edit" role="button" (click)="editButton(i)"/>
                    <img *ngIf="!field.completed" src="../../assets/images/chk-btn.svg" alt="confirm" role="button" (click)="checkButton(i)"/>
                  </div>
                </div>

                <div class="mt-2">
                  <p *ngIf="field.value == '' && field.label !== 'Additional attachments'" class="text-secondary small mb-1">{{ staticText.notFilled }}</p>
                  <p *ngIf="field.value !== ''" class="filled mb-1" [ngClass]="{'text-danger small': field.value == staticText.ADA_STATIC_TEXT}">{{field.value}}</p>

                  <!-- Attachments -->
                  <input type="file" (change)="onFileAttach($event)" #fileInputAttach hidden>
                  <button *ngIf="field.value == '' && field.label == 'Additional attachments' && !uploadFileFirstTime"
                          class="btn btn-link p-0 text-secondary small"
                          (click)="fileInputAttach.click()">
                    {{ staticText.drag }} <span class="text-primary">{{ staticText.choose }}</span>
                  </button>

                  <div *ngIf="uploadFileName && field.label == 'Additional attachments'" class="file-info">
                    <div class="file-icon"><img [src]="fileIcon" alt="" width="28" height="28"/></div>
                    <div class="file-name small">
                      <span class="text-truncate" style="max-width:280px" data-bs-toggle="tooltip" [title]="uploadFileName">{{ uploadFileName}}</span>
                      <p class="mb-0 text-secondary">{{ fileExtension }}</p>
                    </div>
                    <div class="down-del-wrap ms-auto position-relative">
                      <button class="btn btn-link p-0" (click)="showChatDeleteMethod()" aria-expanded="false" aria-haspopup="true">
                        <i class="bi bi-three-dots-vertical"></i>
                      </button>
                      <ul *ngIf="showChatDelete" class="dropdown-menu show end-0 mt-1">
                        <li><button class="dropdown-item d-flex align-items-center gap-2" (click)="downloadFileFromChat()"><img src="../../assets/images/down.svg" alt=""/>{{ staticText.download }}</button></li>
                        <li><button class="dropdown-item d-flex align-items-center gap-2 disabled"><img src="../../assets/images/del.svg" alt=""/>{{ staticText.delete }}</button></li>
                      </ul>
                    </div>
                  </div>

                  <div *ngIf="fileUploadFromAttachment && field.label == 'Additional attachments'" class="file-info">
                    <div class="file-icon"><img [src]="fileIcon" alt="" width="28" height="28"/></div>
                    <div class="file-name small">
                      <span class="text-truncate" style="max-width:280px" data-bs-toggle="tooltip" [title]="fileUploadFromAttachment.name">{{ fileUploadFromAttachment.name }}</span>
                      <p class="mb-0 text-secondary">{{ addfileExtension }}</p>
                    </div>
                    <div class="down-del-wrap ms-auto position-relative">
                      <button class="btn btn-link p-0" (click)="showAttachmentDeleteMethod()">
                        <i class="bi bi-three-dots-vertical"></i>
                      </button>
                      <ul *ngIf="showAttachmentDelete" class="dropdown-menu show end-0 mt-1">
                        <li><button class="dropdown-item d-flex align-items-center gap-2" (click)="downloadFileFromAdditional()"><img src="../../assets/images/down.svg" alt=""/>{{ staticText.download }}</button></li>
                        <li><button class="dropdown-item d-flex align-items-center gap-2" (click)="deleteAttachment()"><img src="../../assets/images/del.svg" alt=""/>{{ staticText.delete }}</button></li>
                      </ul>
                    </div>
                  </div>

                  <div *ngIf="field.value == staticText.ADA_STATIC_TEXT || (field.label == 'Additional comments' && isAdditionalCommentsEmpty && botRespondedFirstTime)">
                    <button class="btn btn-outline-primary btn-sm mt-1" (click)="addButton(i)">{{ staticText.add }}</button>
                  </div>

                  <span *ngIf="field.value !== '' && !field.completed && field.value !== staticText.ADA_STATIC_TEXT && field.label !== 'Areas involved' && field.label !== 'Additional attachments'
                    && field.label !== 'Destination 2027 alignment' && field.label !== 'Timelines' && field.label !== 'Business sponsor'
                    && field.label !== 'Additional comments' && field.label !== 'Business case impacts' && field.label !== 'Portfolio alignment' && field.label !== 'IT sponsor'"
                    class="not-final-content">
                    {{ staticText.finalContent }}
                  </span>
                </div>
              </div>
            </div>

            <div *ngIf="i === 8" class="static-content mt-3">
              <p class="fw-semibold mb-0">{{ staticText.additional }}</p>
            </div>
          </div>
        </div>

        <div class="subnit-btn border-top p-3">
          <button class="btn btn-primary" [disabled]="buttonDisabled" (click)="submitButton()">{{ staticText.submit }}</button>
        </div>

        <!-- toasts/alerts -->
        <div *ngIf="errorDivVisible" class="validation-msg global-valid bg-danger text-white rounded d-flex align-items-center gap-2 px-3 py-2">
          <i class="bi bi-exclamation-triangle"></i><span>{{ errorDivText }}</span>
          <button type="button" class="btn-close btn-close-white ms-auto" aria-label="Close" (click)="errorDivCloseInstant()"></button>
        </div>
        <div *ngIf="successDivVisible" class="validation-msg global-valid bg-success text-white rounded d-flex align-items-center gap-2 px-3 py-2">
          <i class="bi bi-check-circle"></i><span>{{ successDivText }}</span>
          <button type="button" class="btn-close btn-close-white ms-auto" aria-label="Close" (click)="successDivCloseInstant()"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div class="modal fade confirm-dialoge" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true" #reviewModal>
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title fs-5" id="reviewModalLabel">{{ staticText.review }}</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ staticText.reviewDetail }}
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal" aria-label="Close">{{ staticText.CANCEL }}</button>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal" aria-label="Close">{{ staticText.edit }}</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" aria-label="Close" (click)="submitButtonPopup()">{{ staticText.submit }}</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Carousel when first time -->
<app-carousel *ngIf="userComeFirstTime" (hideParent)="hideCrousel()"></app-carousel>
